<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>B: Metaprogramming Ruby | windse7en</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Metaprogramming is writing code that writes codes.
Get all mixed modules for an object:1(class &amp;lt;&amp;lt; obj; self; end).included_modules&amp;gt;&amp;gt;)在runtime下，取得obj的class，查找所有modules
Metaprogramming is wr">
<meta property="og:type" content="article">
<meta property="og:title" content="B: Metaprogramming Ruby">
<meta property="og:url" content="http://yoursite.com/2015/07/27/b-metaprogramming-ruby/index.html">
<meta property="og:site_name" content="windse7en">
<meta property="og:description" content="Metaprogramming is writing code that writes codes.
Get all mixed modules for an object:1(class &amp;lt;&amp;lt; obj; self; end).included_modules&amp;gt;&amp;gt;)在runtime下，取得obj的class，查找所有modules
Metaprogramming is wr">
<meta property="og:image" content="http://snag.gy/8w3Cx.jpg">
<meta property="og:image" content="http://snag.gy/oysCy.jpg">
<meta property="og:image" content="http://snag.gy/7xT16.jpg">
<meta property="og:image" content="http://snag.gy/d4d7T.jpg">
<meta property="og:updated_time" content="2017-02-26T16:16:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="B: Metaprogramming Ruby">
<meta name="twitter:description" content="Metaprogramming is writing code that writes codes.
Get all mixed modules for an object:1(class &amp;lt;&amp;lt; obj; self; end).included_modules&amp;gt;&amp;gt;)在runtime下，取得obj的class，查找所有modules
Metaprogramming is wr">
<meta name="twitter:image" content="http://snag.gy/8w3Cx.jpg">
  
    <link rel="alternative" href="/atom.xml" title="windse7en" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.2d7529.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="null" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">Tao Zhang</a></h1>
		</hgroup>
		
		<p class="header-subtitle">while(1){slef++;}</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="null" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">Tao Zhang</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>while(1){slef++;}<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-b-metaprogramming-ruby" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      B: Metaprogramming Ruby
    </h1>
  

        
        <a href="/2015/07/27/b-metaprogramming-ruby/" class="archive-article-date">
  	<time datetime="2015-07-27T19:28:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-07-27</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>Metaprogramming is writing code that writes codes.</em></p>
<p>Get all mixed modules for an object:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(<span class="class"><span class="keyword">class</span> &lt;&lt; obj;</span> <span class="keyword">self</span>; <span class="keyword">end</span>).included_modules<span class="meta">&gt;&gt;</span>)</div></pre></td></tr></table></figure><br>在runtime下，取得obj的class，查找所有modules</p>
<p><em>Metaprogramming is writing code that manipulates language constructs at runtime.</em></p>
<h1 id="Chapter-1-Monday-The-object-model"><a href="#Chapter-1-Monday-The-object-model" class="headerlink" title="Chapter 1. Monday: The object model"></a>Chapter 1. Monday: The object model</h1><p>Classes themselves are nothing but objects.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">String.<span class="keyword">class</span>        <span class="comment"># =&gt; Class</span></div><div class="line">Class.superclass    <span class="comment"># =&gt; Module</span></div><div class="line">Module.superclass   <span class="comment"># =&gt; Object</span></div></pre></td></tr></table></figure>
<p>User namespace to avoid name clash, Modulename::Classname</p>
<p>obj.instance_variable_set(“@x”,10) 设定实例参数。</p>
<ol>
<li>It finds the method. This is a process called method lookup.</li>
<li>It executes the method. To do that, Ruby needs something called self.</li>
</ol>
<h3 id="Method-Lookup"><a href="#Method-Lookup" class="headerlink" title="Method Lookup"></a>Method Lookup</h3><p>the receiver and the ancestors chain. </p>
<h3 id="Kernel-Method"><a href="#Kernel-Method" class="headerlink" title="Kernel Method"></a>Kernel Method</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">quire ‘rubygems’</div><div class="line">gem ‘rails’ , ‘= <span class="number">2.3</span>.<span class="number">2</span>’</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Kernel</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">gem</span><span class="params">(gem_name, \*version\_requirements)</span></span></div><div class="line">    <span class="comment"># ...</span></div></pre></td></tr></table></figure>
<p>“If you want to become a master of Ruby,” Bill warns you, “you should always know which object has the role self at any given moment.”</p>
<img src="http://snag.gy/8w3Cx.jpg">
<h1 id="Chapter-2-Tuesday-Methods"><a href="#Chapter-2-Tuesday-Methods" class="headerlink" title="Chapter 2. Tuesday: Methods"></a>Chapter 2. Tuesday: Methods</h1><h2 id="Dynamic-Methods"><a href="#Dynamic-Methods" class="headerlink" title="Dynamic Methods"></a>Dynamic Methods</h2><p>Where you learn how to call and define methods dynamically and remove the duplicated code.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">obj.send(<span class="symbol">:my</span>\_method, <span class="number">3</span>) <span class="comment"># =&gt; 6</span></div></pre></td></tr></table></figure>
<p>method_missing is Kernel#method_missing() responded to.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Table</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method</span>\<span class="title">_missing</span><span class="params">(id,\*args,&amp;block)</span></span></div><div class="line">    <span class="keyword">return</span> as($1.to\_sym,\*args,&amp;block) <span class="keyword">if</span> id.to_s =~ <span class="regexp">/^to\_(.\*)/</span></div><div class="line">    <span class="keyword">return</span> rows\_with($1.to\_sym =&gt; args[<span class="number">0</span>]) <span class="keyword">if</span> id.to\_s =~ <span class="regexp">/^rows\_with\_(.\*)/</span></div><div class="line">    <span class="keyword">super</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="comment"># ...</span></div></pre></td></tr></table></figure>
<p>“string”.to_sym 生成对的symbol，用symbol调用方法。用super调用method_missing函数</p>
<h3 id="Dynamic-Proxy"><a href="#Dynamic-Proxy" class="headerlink" title="Dynamic Proxy"></a>Dynamic Proxy</h3><p>DelegateClass( ) is a Mimic Method (241) that creates and returns a new Class. This class defines a method_missing( ) that forwards calls to a wrapped object, such as an Assistant. Manager inherits this method_missing( ), so it becomes a proxy of the wrapped object.</p>
<p>用method_missing方法实现最好也实现respond_to这个method, const_missing可以把missed constant找到方法输出。</p>
<p>下面程序有个bug哦<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Roulette</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method</span>\<span class="title">_missing</span><span class="params">(name, \*args)</span></span></div><div class="line">    person = name.to\_s.capitalize</div><div class="line">    <span class="number">3</span>.times <span class="keyword">do</span></div><div class="line">      number = rand(<span class="number">10</span>) + <span class="number">1</span></div><div class="line">      puts “<span class="comment">#&#123;number&#125;...”</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    “<span class="comment">#&#123;person&#125; got a #&#123;number&#125;”</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><br>number 的scope</p>
<p>Ruby 里面用来去掉继承来的方法的method：<br>Module#undef_method    removes all methods, including the inherited ones.<br>Module#remove_method   removes the method from the receiver, but it leaves inherited methods alone.<br>The Builder library which is an XML generator 就是用了Blank Slate把object的class去掉了。</p>
<p>Ruby 怕方法被override，用reserved method name：__send__() and __id__()</p>
<p>Blank Slate 的样板code：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></div><div class="line">  instance\_methods.each <span class="keyword">do</span> <span class="params">|m|</span></div><div class="line">    <span class="keyword">undef</span>\_method m unless m.to\_s =~ <span class="regexp">/^\_\_|method\_missing|respond\_to?/</span></div><div class="line">  <span class="keyword">end</span></div><div class="line">  <span class="comment"># ...</span></div></pre></td></tr></table></figure></p>
<h1 id="Chapter-3-Wednesday-Blocks"><a href="#Chapter-3-Wednesday-Blocks" class="headerlink" title="Chapter 3. Wednesday: Blocks"></a>Chapter 3. Wednesday: Blocks</h1><img src="http://snag.gy/oysCy.jpg">
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">yield</span> <span class="keyword">if</span> block\_given?</div></pre></td></tr></table></figure>
<p>Closure, the block is a closure. 看不到在my_method里面定义的variable x<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def my\_method</div><div class="line">  x = “Goodbye</div><div class="line">  yield(“cruel”)</div><div class="line">end</div><div class="line"></div><div class="line">x=”Hello”</div><div class="line">my\_method &#123; |y| “#&#123;x&#125; #&#123;y&#125; world”&#125;      # =&gt; “Hello cruel world”</div></pre></td></tr></table></figure></p>
<p>use <em>local-variables</em> to track the local_variables </p>
<p><em>Whenever the program changes scope, some bindings are replaced by a new set of bindings.</em></p>
<p>Scope Gates keywords: class, module, def, end </p>
<h3 id="Beyond-the-Scope-Gates"><a href="#Beyond-the-Scope-Gates" class="headerlink" title="Beyond the Scope Gates"></a>Beyond the Scope Gates</h3><p>Q: Can you think of a method that does the same thing that class does?<br>A: If you look at Ruby’s documentation, you’ll find the answer: Class.new( ) is a perfect replacement for class. You can also define instance methods in the class if you pass a block to Class.new( ):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">my\_var = “Success”</div><div class="line">MyClass = Class.new do</div><div class="line">  # Now we can print my\_var here...</div><div class="line">  puts “#&#123;my\_var&#125; in the class definition!”</div><div class="line">  def my\_method</div><div class="line">  # ...but how can we print it here?</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<p>这个方法叫做nested lexical scopes，也叫做flattening the scope把两个scopes挤压到一起，简称Flat Scope.</p>
<p>Shared Scopes的例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">def define\_methods</div><div class="line">  shared = 0</div><div class="line">  Kernel.send :define\_method, :counter do</div><div class="line">    shared</div><div class="line">  end</div><div class="line">  Kernel.send :define\_method, :inc do |x|</div><div class="line">    shared += x</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">define\_methods</div><div class="line"></div><div class="line">counter # =&gt; 0</div><div class="line">inc(4)</div><div class="line">counter # =&gt; 4</div></pre></td></tr></table></figure></p>
<h3 id="instance-eval"><a href="#instance-eval" class="headerlink" title="instance_eval()"></a>instance_eval()</h3><p>用这个方法可以做Context Probe，把变量放入object中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">v = 2</div><div class="line">obj.instance\_eval &#123; @v = v &#125;</div><div class="line">obj.instance\_eval &#123; @v &#125; # =&gt; 2</div></pre></td></tr></table></figure></p>
<p>这是一种容易打破Encapsulation的方法，用在test中非常有效果</p>
<h3 id="Callable-Objects"><a href="#Callable-Objects" class="headerlink" title="Callable Objects"></a>Callable Objects</h3><p>Proc lambda 两个block object, method 也是一个call的objetct</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">inc = Proc.new &#123;|x| x + 1&#125;</div><div class="line">inc.call(2)</div><div class="line">dec = lambda &#123;|x| x - 1&#125;</div><div class="line">dec.class          # =&gt; Proc</div><div class="line">dec.call(2)        # =&gt; 1</div></pre></td></tr></table></figure>
<p>&amp;block_name 得到一个Proc对象。<br>Procs created with lambda( ) are called lambdas, while the others are simply called procs.</p>
<p>The differences between Proc and lambda:</p>
<ol>
<li>lambda中return返回相关值，Proc的return会直接退出所在的scope。为了避免这个情况，不用return只是写值</li>
<li>当arity，arg的参数数量不一定的时候，如果和block中不一样，lambda会报错，但是Proc会裁剪或者补充nil</li>
</ol>
<p>基于此，一般选择用lambda {} 更安全。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">p = -&gt;(x) &#123; x + 1 &#125;         # 一种替代方法</div><div class="line">p = lambda &#123; |x| x + 1 &#125;</div></pre></td></tr></table></figure></p>
<img src="http://snag.gy/7xT16.jpg">
<p><em>P.121 最后讲的DSL非常清晰的讲了开发过程的几个阶段，多练练</em></p>
<h1 id="Chapter-4-Thursday-Class-Definitions"><a href="#Chapter-4-Thursday-Class-Definitions" class="headerlink" title="Chapter 4. Thursday: Class Definitions"></a>Chapter 4. Thursday: Class Definitions</h1><p>class_eval(), Module#class_eval(), add method to class</p>
<p>“I want to open this object, and I don’t particularly care it’s a class,” then instance_eval( ) is fine. If you’re thinking “I want an Open Class (31) here,” then class_eval( ) is almost certainly a better match.</p>
<p>Use instance variable to set the test data.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class FakeTime</div><div class="line">  def self.now; ‘Mon Apr 06 12:15:50’ ; end</div><div class="line">end</div><div class="line"></div><div class="line">require ‘test/unit’</div><div class="line"></div><div class="line">class TestLoan &lt; Test::Unit::TestCase</div><div class="line">  def test_conversion_to_string</div><div class="line">    Loan.instance_eval &#123; @time_class = FakeTime &#125;</div><div class="line">    loan = Loan.new(‘War and Peace’ )</div><div class="line">    assert_equal ‘WAR AND PEACE loaned on Mon Apr 06 12:15:50’ , loan.to_s</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure></p>
<p>Singleton Methods in Actions:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">paragraph = “any string can be a paragraph”</div><div class="line">def paragraph.title?</div><div class="line">  self.upcase == self</div><div class="line">end</div><div class="line">index(paragraph)</div></pre></td></tr></table></figure><br>只给一个对象添加方法，同一类的不增加此方法。</p>
<h3 id="Class-Macros"><a href="#Class-Macros" class="headerlink" title="Class Macros:"></a>Class Macros:</h3><p>attr_accessor 就是一个Class Macros</p>
<img src="http://snag.gy/d4d7T.jpg">
<p>Ruby doesn’t always tell you the whole truth. Instead of the class that you see, an object can have its own special, hidden class. That’s called the eigenclass of the object<br>对象的固有方法。</p>
<p>增加类方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">class MyClass</div><div class="line">  def self.my\_method; end</div><div class="line">end</div><div class="line"></div><div class="line">def MyClass.my\_other\_method; end</div><div class="line"></div><div class="line"># eigenclass method</div><div class="line">class MyClass</div><div class="line">  class &lt;&lt; self</div><div class="line">    def my\_method; end</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure></p>
<p>Object#extend( ) is simply a shortcut that includes a module in the receiver’s eigenclass. You can always do that yourself, if you so choose.</p>
<h3 id="Aliases"><a href="#Aliases" class="headerlink" title="Aliases"></a>Aliases</h3><p>方法别名。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alias :new\_name :old\_name  # alias is a keyword, not a method, that is why no comma.</div></pre></td></tr></table></figure></p>
<h1 id="Chapter-5-Friday-Code-That-Writes-Code"><a href="#Chapter-5-Friday-Code-That-Writes-Code" class="headerlink" title="Chapter 5. Friday: Code That Writes Code"></a>Chapter 5. Friday: Code That Writes Code</h1><p>facets is a large collection of useful Ruby snippets.<br>Kernel#eval, executes the code in the string and returns the result</p>
<p>here documents: &lt;&lt; END    END</p>
<p>def self.inherited(subclass) 等类被继承的时候会调用此方法。inherited() is a Hook Method, as we can use it to hook into a particular event.<br>Module#included() is another Hook Method<br>Module#extend_object() Module#method_added( ), method_removed( ), or method_undefined( )</p>
<p>Chapter 5重点看一下，这里面有很好的实现，特别重要！！！</p>
<h1 id="Chapter-6-Epilogue"><a href="#Chapter-6-Epilogue" class="headerlink" title="Chapter 6. Epilogue"></a>Chapter 6. Epilogue</h1><p>一个小故事</p>
<h1 id="Chapter-7-The-Design-of-Active-Record"><a href="#Chapter-7-The-Design-of-Active-Record" class="headerlink" title="Chapter 7. The Design of Active Record"></a>Chapter 7. The Design of Active Record</h1><p>Decoupling, Simplicity, No Duplication</p>
<h1 id="Chapter-8-Inside-ActiveRecord"><a href="#Chapter-8-Inside-ActiveRecord" class="headerlink" title="Chapter 8. Inside ActiveRecord"></a>Chapter 8. Inside ActiveRecord</h1><p>dynamic attributes and dynamic finders</p>
<p>Dynamic Attributes: ActiveRecord的源代码很好的解释了怎么用的，在2.3.2版本的ActiveRecord，active_methods.rb文件，里面关于method_missing and respond_to?的重定义，很好的解释了Ghost Method 的用法。</p>
<p>Dynamic Finders: ActiveRecord, base.rb 里面的method missing方法和respond to?方法</p>
<p>There are also techniques and tools that you can leverage to deal with that complexity and to avoid some common metaprogramming pitfalls. Some of these tools, such as unit tests and Monkeypatch guards</p>
<h1 id="Chapter-9-Metaprogramming-Safely"><a href="#Chapter-9-Metaprogramming-Safely" class="headerlink" title="Chapter 9. Metaprogramming Safely"></a>Chapter 9. Metaprogramming Safely</h1><ol>
<li>What’s the pitfall of Metapgrogramming?</li>
<li>How to do unit test?</li>
</ol>
<p>before_filter method is defined in the ActionPack2.3.2/action_controller/filers.rb<br>actionpack-2.3.2/test/controller/filters_test.rb test case for the filters.</p>
<p>Open Class, Monkeypatches is dangerous:</p>
<ol>
<li>is global.</li>
<li>invisible, hard to be viewed. (included as a module, can be seen by the ancestors)</li>
<li>override old method implicitly</li>
</ol>
<p>Rake use method_defined? to defend the Monkeypatch for override old method.</p>
<h1 id="Appendix-A"><a href="#Appendix-A" class="headerlink" title="Appendix A:"></a>Appendix A:</h1><p>Ruby idioms, Metaprogramming spells:</p>
<table>
<thead>
<tr>
<th>Spell</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Argument Arrays</td>
<td>一队列参数</td>
<td>method(*args)</td>
</tr>
<tr>
<td>Around Alias</td>
<td>方法别名</td>
<td>alias :old_reverse :reverse</td>
</tr>
<tr>
<td>Blank Slate</td>
<td>去掉方法定义</td>
<td>undef_method m</td>
</tr>
<tr>
<td>Class Extension Mixin</td>
<td>module中扩展Hook method</td>
<td>module M; extent ModuleName</td>
</tr>
<tr>
<td>Class Macro</td>
<td>类的方法调用Macro</td>
<td>attr_accessor :age</td>
</tr>
<tr>
<td>Clean Room</td>
<td>用一个对象作为环境评价一个block</td>
<td>CleanRoom.new.instance_eval { method }</td>
</tr>
<tr>
<td>Class Extension</td>
<td>混合方法进入eigenclass</td>
<td>class &lt;&lt; C; include M; end</td>
</tr>
<tr>
<td>Code Processor</td>
<td>运行文件里的命令</td>
<td>eval ‘file string’</td>
</tr>
<tr>
<td>Context Probe</td>
<td>用探针访问私有域</td>
<td>obj.instance_eval { @private_variable }</td>
</tr>
<tr>
<td>Deferred Evaluation</td>
<td>调用Proc对象</td>
<td>&block; block.call</td>
</tr>
<tr>
<td>Dynamic Dispatch</td>
<td>动态调用方法</td>
<td>obj.public_send(:method_name)</td>
</tr>
<tr>
<td>Dynamic Method</td>
<td>动态定义方法</td>
<td>define_method :my_method</td>
</tr>
<tr>
<td>Dynamic Proxy</td>
<td>将方法delegate到其他对象</td>
<td>@target.send(name, *args, &amp;block)</td>
</tr>
<tr>
<td>Flat Scope</td>
<td>用block来传值入object</td>
<td>obj.instance_eval { @attr = local_variable}</td>
</tr>
<tr>
<td>Ghost Method</td>
<td>用method_missing和respond_to</td>
<td>method_missing, respond_to</td>
</tr>
<tr>
<td>Hook Method</td>
<td>重写方法反应object model events</td>
<td>def self.inherited(subclass)</td>
</tr>
<tr>
<td>Kernel Method</td>
<td>类似全局函数了</td>
<td>module Kernel;def a_method</td>
</tr>
<tr>
<td>Lazy Instance Variable</td>
<td>直到用的时候才初始化</td>
<td>def attribute; @attribute II= ‘value’</td>
</tr>
<tr>
<td>Mimic Method</td>
<td>attribute=() 就是方法，但是用起来mimic</td>
<td>attr_reader, private</td>
</tr>
<tr>
<td>Monkeypatch</td>
<td>runtime改变class的features</td>
<td>class String; def reverse</td>
</tr>
<tr>
<td>Named Arguments</td>
<td>函数参数的命名</td>
<td>method(args_hash)</td>
</tr>
<tr>
<td>Namespace</td>
<td>避免命名冲突</td>
<td>MyNamespace::Array</td>
</tr>
<tr>
<td>Nil Guards</td>
<td>用来实例化避免nil</td>
<td>@aII= []</td>
</tr>
<tr>
<td>Object Extension</td>
<td>设定唯一方法放到object’s eigenclass中</td>
<td>class &lt;&lt; obj; include M ; end</td>
</tr>
<tr>
<td>Open Class</td>
<td>rutime修改class</td>
<td>class String; def reverse</td>
</tr>
<tr>
<td>Pattern Dispatch</td>
<td>根据名字调用方法</td>
<td>public_send</td>
</tr>
<tr>
<td>Sandbox</td>
<td>沙盒安全运行</td>
<td>proc { $SAFE = 2}.call</td>
</tr>
<tr>
<td>Scope Gate</td>
<td>作用域</td>
<td>class, module, def</td>
</tr>
<tr>
<td>Self Yield</td>
<td>把这个对象传给block</td>
<td>[‘a’,’b’].shift.tap {}.upcase</td>
</tr>
<tr>
<td>Shared Score</td>
<td>测试里面的初始化过程</td>
<td>lambda{ shared=10}.call</td>
</tr>
<tr>
<td>Singleton Method</td>
<td>给唯一对象的方法</td>
<td>class &lt;&lt; obj; def method;end; end</td>
</tr>
<tr>
<td>String of Code</td>
<td>命令放到字符串里</td>
<td>eval(‘1+1’)</td>
</tr>
<tr>
<td>Symbol#to_proc</td>
<td>直接传方法名，当block非常简单的时候</td>
<td>names.map(%:capitalize)</td>
</tr>
</tbody>
</table>
<p>tap 用来给block传自己的对象，debug 更容易<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">class Object</div><div class="line">  def tap</div><div class="line">    yield self</div><div class="line">    self</div><div class="line">  end </div><div class="line">end </div></pre></td></tr></table></figure></p>
<p>Symbol#to_proc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class Symbol</div><div class="line">  def to\_proc</div><div class="line">    Proc.new &#123;|x| x.send(self) &#125;</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">names.map(&amp;:capitalize.to\_proc) #直接调用Symbol#to\_proc</div><div class="line">names.map(&amp;:capitalize)  # 系统简化以后的效果</div></pre></td></tr></table></figure></p>
<p>lambda,proc 不同，主要是参数不同以后的反应，还有return效果，一般都用lambda。<br>Class.ancesters 类的ancestors来看都有哪些modules和class<br>Instance.methods来看都有哪些方法。<br>&amp;block, block.call() 还是不一样的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">class CArray &lt; Array</div><div class="line">  def c(&amp;block)</div><div class="line">    collect! &amp;block  # 等于把block的字符串都考过来collect! &#123; |e| e*2 &#125;</div><div class="line">  end</div><div class="line">end </div><div class="line"></div><div class="line">class CArray &lt; Array</div><div class="line">  def c</div><div class="line">    collect! yield  # it’s the same as the block.call</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure></p>
<p>在源码里面看实现<br><a href="https://www.ruby-lang.org/en/downloads/" target="_blank" rel="external">下载ruby源码</a></p>
<h1 id="Appendix-B-DSL"><a href="#Appendix-B-DSL" class="headerlink" title="Appendix B: DSL"></a>Appendix B: DSL</h1>
      

      
        <div class="page-reward">
          <a href="javascript:;" class="page-reward-btn tooltip-top">
            <div class="tooltip tooltip-east">
            <span class="tooltip-item">
              赏
            </span>
            <span class="tooltip-content">
              <span class="tooltip-text">
                <span class="tooltip-inner">
                  <p class="reward-p"><i class="icon icon-quo-left"></i>谢谢你请我吃糖果<i class="icon icon-quo-right"></i></p>
                  <div class="reward-box">
                    
                    
                  </div>
                </span>
              </span>
            </span>
          </div>
          </a>
        </div>
      
    </div>
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/ruby/" class="article-tag-list-link color5">ruby</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="/categories/metaprogramming/" class="article-tag-list-link color1">metaprogramming</a>
        		</li>
      		
		</ul>
	</div>


      

      
        
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="http://s.jiathis.com/qrcode.php?url=http://yoursite.com/2015/07/27/b-metaprogramming-ruby/" alt="微信分享二维码">
    </div>
</div>

<div class="mask js-mask"></div>
      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2015/07/31/t-chef-ruby/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          T: Chef Ruby
        
      </div>
    </a>
  
  
    <a href="/2015/07/22/learn-linux-command-tips/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Learn: linux command tips</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>






  
    <div class="duoshuo"></div>
  




          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Tao Zhang
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="./",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}])</script><script src="/./main.2d7529.js"></script><script>!function(){var e=function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)};e("/slider.885efe.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>